#!/bin/sh

__dirname=$(dirname "$(readlink -f "$0")")
source "$(readlink -f "$__dirname/../shared.sh")"

EMAIL="yoshuawuyts@gmail.com"

if [ $# = "0" ]; then
  printf 'usage: ew rust <PROJECTNAME>\n'
  exit 1
fi

# define PROJECTNAME
if [ -z "$1" ]; then
  printf 'What is the name of the project?\n❯ '
  read -r PROJECTNAME
  if [ "$PROJECTNAME" = "" ]; then
    printf 'no name provided, exiting\n'
    exit 1
  fi
else
  PROJECTNAME="$1"
fi

# define DESCRIPTION
if [ -z "$2" ]; then
  printf 'What does this project do?\n❯ '
  read -r DESCRIPTION
  if [ "$DESCRIPTION" = "" ]; then
    printf 'no description provided, exiting\n'
    exit 1
  fi
else
  DESCRIPTION="$(echo "$2" | sed 's|\.$||')."
fi

# define USERNAME
if [ -z "$3" ]; then
  printf 'Under what user on GitHub will this project live?\n❯ '
  read -r USERNAME
  if [ "$USERNAME" = "" ]; then
    printf 'no username provided, exiting\n'
    exit 1
  fi
else
  USERNAME="$3"
fi

# Create base project
cargo init --lib "$PROJECTNAME"
ew project-base "$PROJECTNAME" "$DESCRIPTION" "$USERNAME"

# Copy files
pushd "$1"
copy "$__dirname/rustfmt.toml" rustfmt.toml
copy "$__dirname/gitignore" .gitignore
copy "$__dirname/travis.yml" .travis.yml
ew github

readf "$__dirname/lib.rs" \
  | replace DESCRIPTION "$DESCRIPTION" \
  > src/lib.rs

readf "$__dirname/README.md" \
  | replace PROJECTNAME "$PROJECTNAME" \
  | replace DESCRIPTION "$DESCRIPTION" \
  | replace USERNAME "$USERNAME" \
  > README.md

readf "$__dirname/Cargo.toml" \
  | replace PROJECTNAME "$PROJECTNAME" \
  | replace DESCRIPTION "$DESCRIPTION" \
  | replace USERNAME "$USERNAME" \
  | replace AUTHOR "Yoshua Wuyts" \
  | replace EMAIL "$EMAIL" \
  > Cargo.toml

# Base directories
mkdir tests
mkdir examples
mkdir benches

# Empty test file
touch tests/test.rs

popd
